<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flow On ‚Äî Sua Rotina em Movimento</title>

  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="icon" href="assets/img/favicon-32.png" />

  <!-- PWA (m√≠nimo, n√£o mexe em cache) -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0b0d10" />

  <style>
    /* --- extras suaves j√° existentes --- */
    .fo-card{border:1px solid var(--border);border-radius:16px;padding:14px;margin:14px 0;background:rgba(255,255,255,.02)}
    .fo-title{font-size:1.2rem;font-weight:700;margin:0 0 8px}
    .fo-muted{opacity:.7}
    .fo-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:8px}
    .fo-kpi{border:1px solid var(--border);border-radius:12px;padding:12px}
    .fo-kpi strong{font-size:1.3rem}
    /* 21 dias */
    .fo-dots{display:grid;grid-template-columns:repeat(21,10px);gap:6px;margin-top:8px}
    .fo-dot{width:10px;height:10px;border-radius:50%;border:1px solid var(--border);opacity:.6}
    .fo-dot.on{background:linear-gradient(180deg,#50fa7b,#2ecc71);border-color:transparent;opacity:1}
    .fo-habit-row{margin:10px 0}
    .fo-habit-name{font-weight:600;margin-bottom:6px}
    .fo-link{color:#7aa2ff;text-decoration:underline}
    /* compat: linha de h√°bito semanal */
    .h-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed var(--border)}
    .h-row:last-child{border-bottom:0}
    .h-name{font-weight:600}
    .h-dots{display:flex;align-items:center;gap:8px}
    .ring-dot{width:12px;height:12px;border:2px solid #2ecc71;border-radius:50%}
    .ring-dot.done{background:linear-gradient(180deg,#50fa7b,#2ecc71);border-color:transparent}
    .h-pct{font-size:.85rem;opacity:.7}
    .list-day{padding:10px;border:1px solid var(--border);border-radius:12px;margin:8px 0}
    .list-day-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .badge{border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:.85rem}
    .small{font-size:.85rem}

    /* ================== AJUSTES DE HEADER + NAV ================== */
    :root{
      --surface: rgba(20,20,20,.7);
      --text: #cfcfd3;
      --text-strong: #ffffff;
      --brand: #f2a65a;
      --brand-ghost: rgba(242,166,90,.18);
      --border: var(--border, rgba(255,255,255,.08));
      --radius: 14px;
      --radius-lg: 18px;
    }

    /* Topbar com logo centralizada */
    .fo-topbar{
      position: sticky; top: 0; z-index: 50;
      display: flex; justify-content: center; align-items: center;
      padding: 10px 12px;
      background: var(--surface);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .fo-brand{display:inline-flex;align-items:center;gap:10px;text-decoration:none}
    .fo-logo{width:28px;height:28px;display:block;filter:drop-shadow(0 0 6px var(--brand-ghost))}
    .fo-brand-text{color:var(--brand);font-weight:600;letter-spacing:.6px;font-size:1.05rem}

    /* Dock de navega√ß√£o centralizado (√≠cone + r√≥tulo) */
    .fo-nav{
      position: sticky; top: 60px; z-index: 40;
      display:flex;justify-content:center;align-items:center;gap:22px;
      padding:14px 10px;margin:10px auto 18px;width:min(980px,96%);
      background:var(--surface); backdrop-filter: blur(8px);
      border:1px solid var(--border); border-radius:var(--radius-lg);
    }
    .fo-item{
      text-decoration:none;color:var(--text);
      display:grid;place-items:center;gap:6px;
      padding:8px 10px;min-width:74px;border-radius:var(--radius);
      transition:transform .18s ease,color .18s ease,background .18s ease,box-shadow .18s ease;
    }
    .fo-item .fo-ico{font-size:1.4rem;line-height:1}
    .fo-item .fo-label{font-size:.9rem;font-weight:500}
    .fo-item:hover,.fo-item:focus-visible{color:var(--text-strong);background:rgba(255,255,255,.04);transform:translateY(-1px);outline:none}
    .fo-item.is-active{
      color:var(--text-strong);
      background:linear-gradient(180deg,rgba(242,166,90,.16),rgba(242,166,90,.06));
      box-shadow:0 6px 14px rgba(242,166,90,.12), inset 0 0 0 1px rgba(242,166,90,.35);
    }
    @media (max-width:380px){
      .fo-nav{gap:14px}
      .fo-item{min-width:66px;padding:8px 8px}
      .fo-item .fo-label{font-size:.85rem}
    }
    /* Garantia: some com qualquer marca antiga em canto */
    #flowon-badge,.fo-watermark,.flowon-mark{display:none!important}
    /* Container da p√°gina (mant√©m teu grid) */
    .container{width:min(980px,94%);margin:18px auto 80px}
  </style>
</head>
<body>

  <!-- ======= TOPBAR + NAV Centralizados ======= -->
  <header class="fo-topbar">
    <a class="fo-brand" href="./">
      <img src="assets/img/logo.svg" alt="Flow On logo" class="fo-logo" />
      <span class="fo-brand-text">Flow On</span>
    </a>
  </header>

  <nav class="fo-nav" role="navigation" aria-label="Navega√ß√£o principal">
    <a class="fo-item is-active active" href="./" aria-label="Home">
      <span class="fo-ico" aria-hidden="true">üè†</span>
      <span class="fo-label">Home</span>
    </a>
    <a class="fo-item" href="pages/journal/" aria-label="Journal">
      <span class="fo-ico" aria-hidden="true">üìì</span>
      <span class="fo-label">Journal</span>
    </a>
    <a class="fo-item" href="pages/themes/" aria-label="Temas">
      <span class="fo-ico" aria-hidden="true">üé¨</span>
      <span class="fo-label">Temas</span>
    </a>
    <a class="fo-item" href="pages/settings/" aria-label="Configura√ß√µes">
      <span class="fo-ico" aria-hidden="true">‚öôÔ∏è</span>
      <span class="fo-label">Configura√ß√µes</span>
    </a>
  </nav>
  <!-- ========================================== -->

  <main class="container">
    <!-- Progresso Geral -->
    <section class="fo-card" id="progress-card">
      <h2 class="fo-title">Progresso Geral</h2>
      <div class="fo-kpis">
        <div class="fo-kpi"><div class="fo-muted">H√°bitos (semana)</div><strong id="kpi-habits">‚Äî</strong></div>
        <div class="fo-kpi"><div class="fo-muted">Dailies (7 dias)</div><strong id="kpi-dailies">0</strong></div>
        <div class="fo-kpi"><div class="fo-muted">Conte√∫dos (pr√≥x. 7 dias)</div><strong id="kpi-posts">0</strong></div>
      </div>
    </section>

    <!-- Vis√£o do Trimestre -->
    <section class="fo-card" id="quarter-card">
      <h2 class="fo-title">Vis√£o do Trimestre <span class="fo-muted" id="quarter-label"></span></h2>
      <div class="fo-muted" id="quarter-notes" style="white-space:pre-line">Sem anota√ß√µes do trimestre ainda.</div>
      <div style="margin-top:8px">
        <a class="fo-link" href="pages/quarterly/">Abrir p√°gina do Trimestral</a>
      </div>
    </section>

    <!-- H√°bitos -->
    <section class="card" id="habits-card">
      <h2>H√°bitos da Semana
        <button id="btn-habits-21" class="btn small" style="margin-left:8px">üìà 21 dias</button>
      </h2>
      <div id="habits-summary"><p>Carregando h√°bitos...</p></div>
      <div id="habits-21-panel" style="display:none"></div>
    </section>

    <!-- Agenda de Conte√∫do -->
    <section class="card">
      <h2>Agenda de Conte√∫do</h2>
      <div id="content-summary">
        <p>Carregando publica√ß√µes...</p>
      </div>
    </section>

    <!-- Resumo do Journal -->
    <section class="card">
      <h2>Resumo do Journal</h2>
      <div id="journal-summary">
        <p>Carregando registros...</p>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>Flow On ¬© 2025 ‚Äî Planeje. Execute. Evolua.</p>
  </footer>

  <!-- ============ JS EMBUTIDO (compat com v√°rios formatos de storage) ============ -->
  <script>
  document.addEventListener('DOMContentLoaded', function(){
    /* ===== Carrega estados (v2 e legado) ===== */
    const KEY_V2='flowon.v2';
    const KEY_OLD='flowon';
    let S={}, SOLD={};
    try{ S    = JSON.parse(localStorage.getItem(KEY_V2)||'{}'); }catch(e){ S={}; }
    try{ SOLD = JSON.parse(localStorage.getItem(KEY_OLD)||'{}'); }catch(e){ SOLD={}; }

    // ------- Helpers de data (local) -------
    const toISO = d => d.toISOString().slice(0,10);
    const todayISO = () => { const d=new Date(); d.setHours(0,0,0,0); return toISO(d); };
    const addDays = (iso,n)=>{ const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return toISO(d); };
    const parseLocal = iso => { const [y,m,d]=(iso||'').split('-').map(Number); return new Date(y,(m||1)-1,d||1); };
    function mondayOfWeekISO(iso) {
      const d = parseLocal(iso);
      const off = (d.getDay()+6)%7;
      d.setDate(d.getDate()-off);
      return toISO(d);
    }
    function weekRangeFromISO(iso){
      const mon = mondayOfWeekISO(iso);
      return [...Array(7)].map((_,i)=> addDays(mon, i));
    }
    function weekKeyOfISO(iso){
      const d=parseLocal(iso);
      const onejan=new Date(d.getFullYear(),0,1);
      const day=Math.floor((d-onejan)/86400000)+1;
      const wk=Math.ceil((day+((onejan.getDay()+6)%7))/7);
      return `${d.getFullYear()}-W${String(wk).padStart(2,'0')}`;
    }
    function dayIndexOfISO(iso){ const d=parseLocal(iso); return (d.getDay()+6)%7; }

    /* ===== Normalizadores de dados ===== */
    const isOn = v => v===true || v===1 || v==='1' || v==='true' || v==='on' || v==='‚úî' || v==='‚úì';
    function getHabits(){
      // tenta v√°rias ra√≠zes conhecidas
      if (Array.isArray(SOLD?.journal?.habits?.items) && SOLD.journal.habits.items.length) return SOLD.journal.habits.items;
      if (Array.isArray(SOLD?.habits) && SOLD.habits.length) return SOLD.habits;
      if (Array.isArray(S?.journal?.habits?.items) && S.journal.habits.items.length) return S.journal.habits.items;
      if (Array.isArray(S?.habits) && S.habits.length) return S.habits;
      return [];
    }
    // retorna se h√° check em um dia ISO para um h√°bito em QUALQUER esquema
    function getCheck(h, iso){
      const wk  = weekKeyOfISO(iso);
      const idx = dayIndexOfISO(iso);

      // 1) esquema por semana: checks[weekKey] => array[7] ou objeto {0..6}
      const cw = h?.checks?.[wk];
      if (Array.isArray(cw)) return isOn(cw[idx]);
      if (cw && typeof cw==='object') return isOn(cw[idx] ?? cw[String(idx)]);

      // 2) esquema por data direta
      if (h?.byDate && typeof h.byDate==='object') return isOn(h.byDate[iso]);
      if (h?.checks?.byDate && typeof h.checks.byDate==='object') return isOn(h.checks.byDate[iso]);
      if (h?.progress && typeof h.progress==='object') return isOn(h.progress[iso]);

      // 3) fallback: array flat recente (7 √∫ltimos)
      if (Array.isArray(h?.checks)) {
        // assume que √© a semana atual
        return isOn(h.checks[idx]);
      }
      return false;
    }

    // constr√≥i s√©rie de 21 dias para o painel, independente do esquema
    function series21(h){
      // √∫ltimos 21 dias at√© hoje
      const today = todayISO();
      const arr = [];
      for(let i=20;i>=0;i--){
        const iso = addDays(today, -i);
        arr.push(getCheck(h, iso));
      }
      return arr;
    }

    /* ===== Progresso Geral ===== */
    (function renderProgress(){
      const habits = getHabits();
      const weekDays = weekRangeFromISO(todayISO());
      let done=0,total=0;

      habits.forEach(h=>{
        weekDays.forEach(iso=>{
          total += 1;
          if (getCheck(h, iso)) done += 1;
        });
      });
      const habitsPct = total ? Math.round(done/total*100)+'%' : '‚Äî';

      // dailies 7 dias (v2 array OU legado byDate)
      let d7 = 0;
      const past7 = [...Array(7)].map((_,i)=> addDays(todayISO(), -i));
      const dailyArr    = S.journal?.daily;
      const dailyByDate = SOLD?.journal?.daily?.byDate;
      if (Array.isArray(dailyArr)) {
        d7 = dailyArr.filter(r=> r?.date && past7.includes(r.date) && (r.focus||r.notes||r.mits||r.gratitude)).length;
      } else if (dailyByDate && typeof dailyByDate==='object') {
        d7 = past7.filter(d=> {
          const v = dailyByDate[d];
          return v && (v.focus||v.notes||v.mits||v.gratitude);
        }).length;
      }

      // conte√∫dos pr√≥ximos 7 dias (v2)
      let posts7 = 0;
      for(let i=0;i<7;i++){
        const d=addDays(todayISO(), i);
        const arr=(S.posts||[]).filter(p=>!p.archived && p.status!=='Rascunho' && p.date===d);
        posts7 += arr.length;
      }

      document.getElementById('kpi-habits').textContent  = habitsPct;
      document.getElementById('kpi-dailies').textContent = String(d7);
      document.getElementById('kpi-posts').textContent   = String(posts7);
    })();

    /* ===== Vis√£o do Trimestre ===== */
    (function renderQuarter(){
      const d = parseLocal(todayISO());
      const y = d.getFullYear();
      const q = Math.floor(d.getMonth()/3)+1;
      const key = `${y}-T${q}`;
      const label = `T${q} de ${y}`;
      document.getElementById('quarter-label').textContent = `(${label})`;

      let notes = S.journal?.tri?.byQuarter?.[key] || '';
      if(!notes){
        const J = SOLD.journal || {};
        const roots = [ J.tri, J.quarterly, J.trimestral, J ];
        for(const r of roots){
          if(!r) continue;
          if(r.byQuarter && r.byQuarter[key]) { notes = r.byQuarter[key]; break; }
          if(r[key]) { notes = r[key]; break; }
        }
      }
      document.getElementById('quarter-notes').textContent = notes || 'Sem anota√ß√µes do trimestre ainda.';
    })();

    /* ===== H√°bitos (semana) ===== */
    (function renderHabitsSummary(){
      const el = document.getElementById('habits-summary');
      const habits = getHabits();
      const weekDays = weekRangeFromISO(todayISO());
      let html='';

      habits.forEach(h=>{
        const dots = weekDays.map(iso=> `<span class="ring-dot ${getCheck(h, iso)?'done':''}"></span>`).join('');
        const wk = weekKeyOfISO(weekDays[0]);
        // calcula % pela pr√≥pria semana mostrada
        const pct = Math.round( (weekDays.filter(iso=>getCheck(h, iso)).length/7)*100 ) || 0;
        html += `<div class="h-row">
          <div class="h-name">${h.name||h.title||'H√°bito'}</div>
          <div class="h-dots">${dots}<div class="h-pct">${pct}%</div></div>
        </div>`;
      });

      if(!habits.length) html = `<div class="muted">Sem h√°bitos cadastrados. Edite em <b>Journal ‚Üí H√°bitos</b>.</div>`;
      el.innerHTML = html + `<div class="muted" style="margin-top:6px">* vis√£o geral ‚Äî edite em Journal ‚Üí H√°bitos</div>`;
    })();

    /* ===== 21 dias ===== */
    (function setupHabits21(){
      const btn = document.getElementById('btn-habits-21');
      const panel = document.getElementById('habits-21-panel');
      if(!btn || !panel) return;

      const habits = getHabits();
      if(!habits.length){ btn.style.display='none'; return; }

      function build(){
        const habitsNow = getHabits();
        panel.innerHTML='';
        habitsNow.forEach(h=>{
          const series = series21(h);
          const row = document.createElement('div'); row.className='fo-habit-row';
          row.innerHTML = `<div class="fo-habit-name">${h.name||h.title||'H√°bito'}</div>`;
          const grid = document.createElement('div'); grid.className='fo-dots';
          series.forEach(v=>{ const dot=document.createElement('div'); dot.className='fo-dot'+(v?' on':''); grid.appendChild(dot); });
          row.appendChild(grid); panel.appendChild(row);
        });
      }

      btn.addEventListener('click', ()=>{
        const open = panel.style.display==='block';
        if(open){ panel.style.display='none'; btn.textContent='üìà 21 dias'; }
        else { build(); panel.style.display='block'; btn.textContent='Ocultar 21 dias'; }
      });
    })();

    /* ===== Agenda de Conte√∫do ===== */
    (function renderContentSummary(){
      const el = document.getElementById('content-summary');
      const dates = weekRangeFromISO(todayISO());
      const today = todayISO();

      const statusBadge = (dateStr, status)=>{
        if(status==='Agendado'){
          if(dateStr < today) return `<span class="badge" style="background:#321; border-color:#633; color:#f8d7da">Atrasado</span>`;
          if(dateStr === today) return `<span class="badge" style="background:#332b00; border-color:#806b00; color:#ffec99">Pendente</span>`;
          return `<span class="badge" style="background:#102915; border-color:#1f6f34; color:#b7ffd1">Agendado</span>`;
        }
        if(status==='Publicado') return `<span class="badge" style="background:#0e2a3a; border-color:#1f5168; color:#a8e1ff">Publicado</span>`;
        return '';
      };

      let html = '';
      dates.forEach(d=>{
        const items = (S.posts||[]).filter(p=> !p.archived && p.status!=='Rascunho' && p.date === d);
        const list = items.length
          ? items.map(p=>{
              const theme = (S.themes||[]).find(t=>t.id===p.themeId);
              const labelMap = {yt_long:'YouTube',short:'Reels/TikTok',carousel:'Carrossel',static:'Imagem',blog:'Blog'};
              const label = labelMap[p.type] || p.type || 'Post';
              return `<div class="small badge" style="display:flex; align-items:center; gap:6px; margin:2px 4px 0 0">
                <span>${theme?.title||'‚Äî'} ‚Ä¢ ${label}</span>${statusBadge(p.date, p.status)}
              </div>`;
            }).join('')
          : `<span class="muted">Sem itens</span>`;

        const display = parseLocal(d).toLocaleDateString('pt-BR',{weekday:'short', day:'2-digit'});
        html += `<div class="list-day"><div class="list-day-head">
            <span>${display}</span><span class="muted">semana</span></div><div>${list}</div></div>`;
      });
      el.innerHTML = html;
    })();

    /* ===== Resumo do Journal (Monthly) ===== */
    (function renderJournalSummary(){
      const el = document.getElementById('journal-summary');
      const dates = weekRangeFromISO(todayISO());
      const items = (S.journal?.month?.items || []).filter(it=> !it.archived);

      let html = '';
      dates.forEach(d=>{
        const dayItems = items.filter(it=> it.date === d);
        const list = dayItems.length
          ? dayItems.map(it=>{
              const badge = it.done
                ? `<span class="badge" style="background:#0e2a3a; border-color:#1f5168; color:#a8e1ff">Conclu√≠do</span>`
                : `<span class="badge" style="background:#332b00; border-color:#806b00; color:#ffec99">Pendente</span>`;
              return `<div class="small badge" style="display:flex; align-items:center; gap:6px; margin:2px 4px 0 0">
                  <span>${it.title}</span>${badge}
                </div>`;
            }).join('')
          : `<span class="muted">Sem itens</span>`;

        const display = parseLocal(d).toLocaleDateString('pt-BR',{weekday:'short', day:'2-digit'});
        html += `<div class="list-day j-card">
            <div class="list-day-head"><span class="small" style="opacity:.8">${display}</span>
            <span class="muted">agenda</span></div>
            <div>${list}</div>
          </div>`;
      });
      el.innerHTML = html;
    })();

  });
  </script>

  <!-- Registro do Service Worker (neutro; n√£o faz cache) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js', { scope: './' })
          .catch(err => console.warn('[PWA] SW error:', err));
      });
    }
  </script>
</body>
</html>