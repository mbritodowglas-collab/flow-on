<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flow On ‚Äî Sua Rotina em Movimento</title>

  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="icon" href="assets/img/favicon-32.png" />

  <!-- PWA (m√≠nimo, n√£o mexe em cache) -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0b0d10" />

  <style>
    /* --- extras suaves j√° existentes --- */
    .fo-card{border:1px solid var(--border);border-radius:16px;padding:14px;margin:14px 0;background:rgba(255,255,255,.02)}
    .fo-title{font-size:1.2rem;font-weight:700;margin:0 0 8px}
    .fo-muted{opacity:.7}
    .fo-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:8px}
    .fo-kpi{border:1px solid var(--border);border-radius:12px;padding:12px}
    .fo-kpi strong{font-size:1.3rem}
    /* 21 dias */
    .fo-dots{display:grid;grid-template-columns:repeat(21,10px);gap:6px;margin-top:8px}
    .fo-dot{width:10px;height:10px;border-radius:50%;border:1px solid var(--border);background:rgba(255,255,255,0.05);opacity:.8}
    .fo-dot.on{background:linear-gradient(180deg,#50fa7b,#2ecc71);border-color:transparent;opacity:1}
    .fo-habit-row{margin:10px 0}
    .fo-habit-name{font-weight:600;margin-bottom:6px}
    .fo-link{color:#7aa2ff;text-decoration:underline}
    /* compat: linha de h√°bito semanal */
    .h-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed var(--border)}
    .h-row:last-child{border-bottom:0}
    .h-name{font-weight:600}
    .h-dots{display:flex;align-items:center;gap:8px}
    .ring-dot{width:12px;height:12px;border:2px solid #2ecc71;border-radius:50%}
    .ring-dot.done{background:linear-gradient(180deg,#50fa7b,#2ecc71);border-color:transparent}
    .ring-dot.miss{background:linear-gradient(180deg,#ff8a8a,#ff6b6b);border-color:transparent}
    .h-pct{font-size:.85rem;opacity:.7}
    .list-day{padding:10px;border:1px solid var(--border);border-radius:12px;margin:8px 0}
    .list-day-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .badge{border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:.85rem}
    .small{font-size:.85rem}

    /* ================== AJUSTES DE HEADER + NAV ================== */
    :root{
      --surface: rgba(20,20,20,.7);
      --text: #cfcfd3;
      --text-strong: #ffffff;
      --brand: #f2a65a;
      --brand-ghost: rgba(242,166,90,.18);
      --border: var(--border, rgba(255,255,255,.08));
      --radius: 14px;
      --radius-lg: 18px;
    }

    /* Topbar com logo centralizada */
    .fo-topbar{
      position: sticky; top: 0; z-index: 50;
      display: flex; justify-content: center; align-items: center;
      padding: 10px 12px;
      background: var(--surface);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .fo-brand{display:inline-flex;align-items:center;gap:10px;text-decoration:none}
    .fo-logo{width:28px;height:28px;display:block;filter:drop-shadow(0 0 6px var(--brand-ghost))}
    .fo-brand-text{color:var(--brand);font-weight:600;letter-spacing:.6px;font-size:1.05rem}

    /* Dock de navega√ß√£o centralizado (√≠cone + r√≥tulo) */
    .fo-nav{
      position: sticky; top: 60px; z-index: 40;
      display:flex;justify-content:center;align-items:center;gap:22px;
      padding:14px 10px;margin:10px auto 18px;width:min(980px,96%);
      background:var(--surface); backdrop-filter: blur(8px);
      border:1px solid var(--border); border-radius:var(--radius-lg);
    }
    .fo-item{
      text-decoration:none;color:var(--text);
      display:grid;place-items:center;gap:6px;
      padding:8px 10px;min-width:74px;border-radius:var(--radius);
      transition:transform .18s ease,color .18s ease,background .18s ease,box-shadow .18s ease;
    }
    .fo-item .fo-ico{font-size:1.4rem;line-height:1}
    .fo-item .fo-label{font-size:.9rem;font-weight:500}
    .fo-item:hover,.fo-item:focus-visible{color:var(--text-strong);background:rgba(255,255,255,.04);transform:translateY(-1px);outline:none}
    .fo-item.is-active{
      color:var(--text-strong);
      background:linear-gradient(180deg,rgba(242,166,90,.16),rgba(242,166,90,.06));
      box-shadow:0 6px 14px rgba(242,166,90,.12), inset 0 0 0 1px rgba(242,166,90,.35);
    }
    @media (max-width:380px){
      .fo-nav{gap:14px}
      .fo-item{min-width:66px;padding:8px 8px}
      .fo-item .fo-label{font-size:.85rem}
    }
    #flowon-badge,.fo-watermark,.flowon-mark{display:none!important}
    .container{width:min(980px,94%);margin:18px auto 80px}
  </style>
</head>
<body>

  <header class="fo-topbar">
    <a class="fo-brand" href="./">
      <img src="assets/img/logo.svg" alt="Flow On logo" class="fo-logo" />
      <span class="fo-brand-text">Flow On</span>
    </a>
  </header>

  <nav class="fo-nav" role="navigation" aria-label="Navega√ß√£o principal">
    <a class="fo-item is-active active" href="./" aria-label="Home">
      <span class="fo-ico" aria-hidden="true">üè†</span>
      <span class="fo-label">Home</span>
    </a>
    <a class="fo-item" href="pages/journal/" aria-label="Journal">
      <span class="fo-ico" aria-hidden="true">üìì</span>
      <span class="fo-label">Journal</span>
    </a>
    <a class="fo-item" href="pages/themes/" aria-label="Temas">
      <span class="fo-ico" aria-hidden="true">üé¨</span>
      <span class="fo-label">Temas</span>
    </a>
    <a class="fo-item" href="pages/settings/" aria-label="Configura√ß√µes">
      <span class="fo-ico" aria-hidden="true">‚öôÔ∏è</span>
      <span class="fo-label">Configura√ß√µes</span>
    </a>
  </nav>

  <main class="container">
    <section class="fo-card" id="progress-card">
      <h2 class="fo-title">Progresso Geral</h2>
      <div class="fo-kpis">
        <div class="fo-kpi"><div class="fo-muted">H√°bitos (semana)</div><strong id="kpi-habits">‚Äî</strong></div>
        <div class="fo-kpi"><div class="fo-muted">Dailies (7 dias)</div><strong id="kpi-dailies">0</strong></div>
        <div class="fo-kpi"><div class="fo-muted">Conte√∫dos (pr√≥x. 7 dias)</div><strong id="kpi-posts">0</strong></div>
      </div>
    </section>

    <section class="fo-card" id="quarter-card">
      <h2 class="fo-title">Vis√£o do Trimestre <span class="fo-muted" id="quarter-label"></span></h2>
      <div class="fo-muted" id="quarter-notes" style="white-space:pre-line">Sem anota√ß√µes do trimestre ainda.</div>
      <div style="margin-top:8px">
        <a class="fo-link" href="pages/quarterly/">Abrir p√°gina do Trimestral</a>
      </div>
    </section>

    <section class="card" id="habits-card">
      <h2>H√°bitos da Semana
        <button id="btn-habits-21" class="btn small" style="margin-left:8px">üìà 21 dias</button>
      </h2>
      <div id="habits-summary"><p>Carregando h√°bitos...</p></div>
      <div id="habits-21-panel" style="display:none"></div>
    </section>

    <section class="card">
      <h2>Agenda de Conte√∫do</h2>
      <div id="content-summary"><p>Carregando publica√ß√µes...</p></div>
    </section>

    <section class="card">
      <h2>Resumo do Journal</h2>
      <div id="journal-summary"><p>Carregando registros...</p></div>
    </section>
  </main>

  <footer class="footer">
    <p>Flow On ¬© 2025 ‚Äî Planeje. Execute. Evolua.</p>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    const KEY_V2='flowon.v2';
    const KEY_OLD='flowon';
    let S={}, SOLD={};
    try{ S=JSON.parse(localStorage.getItem(KEY_V2)||'{}'); }catch(e){S={};}
    try{ SOLD=JSON.parse(localStorage.getItem(KEY_OLD)||'{}'); }catch(e){SOLD={};}

    const toISO=d=>d.toISOString().slice(0,10);
    const todayISO=()=>{const d=new Date();d.setHours(0,0,0,0);return toISO(d);};
    const addDays=(iso,n)=>{const d=new Date(iso+'T00:00:00');d.setDate(d.getDate()+n);return toISO(d);};
    const parseLocal=iso=>{const [y,m,d]=(iso||'').split('-').map(Number);return new Date(y,(m||1)-1,d||1);};
    const mondayOfWeekISO=iso=>{const d=parseLocal(iso);const off=(d.getDay()+6)%7;d.setDate(d.getDate()-off);return toISO(d);};
    const weekRangeFromISO=iso=>{const mon=mondayOfWeekISO(iso);return[...Array(7)].map((_,i)=>addDays(mon,i));};

    const getHabitsData=()=>{
      const H=SOLD?.journal?.habits||{};return{
        items:Array.isArray(H.items)?H.items:[],
        marks:(H.marks&&typeof H.marks==='object')?H.marks:{}
      };
    };
    const getMarkFor=(marks,iso,id)=>{
      const m=marks[iso];if(!m)return undefined;
      if(Array.isArray(m))return m.includes(id)?1:0;
      if(typeof m==='object')return(m[id]===1)?1:(m[id]===0?0:undefined);
    };

    (function renderHabitsSummary(){
      const el=document.getElementById('habits-summary');
      if(!el)return;
      const{items,marks}=getHabitsData();
      const weekDays=weekRangeFromISO(todayISO());
      const today=todayISO();
      if(!items.length){el.innerHTML=`<div class="muted">Sem h√°bitos cadastrados. Edite em <b>Journal ‚Üí H√°bitos</b>.</div>`;return;}
      let html='';
      items.forEach(h=>{
        const id=h.id||h.key||h.title;
        const dots=weekDays.map(iso=>{
          const v=getMarkFor(marks,iso,id);
          let cls='ring-dot';
          if(v===1)cls+=' done';
          else if(v===0&&iso<today)cls+=' miss';
          return `<span class="${cls}" title="${iso}"></span>`;
        }).join('');
        const ones=weekDays.reduce((a,iso)=>a+(getMarkFor(marks,iso,id)===1?1:0),0);
        const pct=Math.round((ones/7)*100);
        html+=`<div class="h-row"><div class="h-name">${h.title||h.name||'H√°bito'}</div><div class="h-dots">${dots}<div class="h-pct">${pct}%</div></div></div>`;
      });
      el.innerHTML=html+`<div class="muted" style="margin-top:6px">* vis√£o geral ‚Äî edite em Journal ‚Üí H√°bitos</div>`;
    })();
  });
  </script>

  <script>
  if('serviceWorker'in navigator){
    window.addEventListener('load',()=>{
      navigator.serviceWorker.register('./service-worker.js',{scope:'./'})
      .catch(err=>console.warn('[PWA] SW error:',err));
    });
  }
  </script>
</body>
</html>